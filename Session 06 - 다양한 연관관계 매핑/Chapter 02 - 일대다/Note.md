# 일대다
> 작성자: @hw130

## 목차  
- [일대다](#일대다)  
- [일대다 단방향](#일대다-단방향)  
- [일대다 단방향 단점](#일대다-단방향-단점)  
- [일대다 양방향](#일대다-양방향)  
- [결론 및 정리](#결론-및-정리)  
### 일대다  
---  
- 일대다 관계는 다대일 관계의 반대 방향으로 "일"이 연관관계의 주인이 된다.(앞을 연관관계 주인이라고 생각하면 된다. )  
- "일"에서는 엔티티를 하나 이상 참조할 수 있으므로 자바 컬렉션인 Collection, List, Set, Map 중에 하나를 사용해야 한다.  

### 일대다 단방향  
---  
- 팀과 회원(일대다) 관계라고 생각했을 때, 팀은 모든 회원들을 참조하지만 회원들은 팀을 참조하지 않으면 이를 일대다 단방향이라 한다.  
<img width="647" alt="스크린샷 2023-07-30 오후 12 04 43" src="https://github.com/luke0408/study_for_jpa_basic/assets/87763333/85ededdb-d231-4c6b-8c60-a6757094e626">  
- 위와 같은 그림이 나오게 된다. 왜냐하면 참조는 Team이 가지고 있는데(객체) 반면, 일대다 관계에서 외래 키는 항상 다쪽 테이블에 존재하기 때문이다. 따라서 크로스 되는(매핑한 객체가 관리하는 외래 키가 다른 테이블에 있는 경우) 상황이 발생한다.  
- 본인 테이블에 외래 키가 있으면 엔티티 저장과 연관관계 처리를 INSERT 쿼리 한 번으로 끝낼 수 있지만, 다른 테이블에 외래 키가 있으면 연관관계 처리를 위한 UPDATE 쿼리를 추가로 실행해야 한다.  
    - 첫 번째 Update 쿼리: 새로운 멤버의 데이터를 멤버 테이블에 삽입한다. 이 때, 멤버 테이블의 외래 키를 해당 멤버가 속한 팀의 기본 키로 설정한다. (즉, 팀과 멤버 테이블을         연결한다.) `INSERT INTO MemberTable (멤버 이름, 팀 ID) VALUES ('Tom', 1);`  
    - 두 번째 Update 쿼리: 팀 테이블의 데이터를 업데이트하여 해당 팀의 멤버 수를 증가시킨다. 이 때, 팀 테이블의 외래 키를 사용하여 연관된 멤버 수를 변경한다. `UPDATE            TeamTable SET 멤버 수 = 멤버 수 + 1 WHERE 팀 ID = 1;`  


### 일대다 단방향 단점  
---  
1. 엔티티가 관리하는 외래 키가 다른 테이블에 있음  
2. 연관관계 관리를 위해 추가로 UPDATE SQL 실행  
3. 일대다 단방향 매핑보다는 다대일 양방향 매핑을 사용하자.  


### 일대다 양방향  
---  
<img width="556" alt="스크린샷 2023-07-30 오후 12 06 00" src="https://github.com/luke0408/study_for_jpa_basic/assets/87763333/d125be14-5790-44ed-b86b-02aebf7e21d8">  
- `@JoinColumn(name = "TEAM_ID", insertable = false, updatable = false)` 와 같은 읽기 전용 필드를 사용해서 양방향 처럼 사용하는 방법  
- 결론부터 말하자면, 일대다 양방향은 존재하지 않는다. 실제로 @ManyToOne 어노테이션에는 mappedBy 속성이 없는데, 이는 이 관계에서 One 쪽이 연관관계의 주인이 될 수 없음을 시사한다.  
- 이유는 당연히 항상 다 쪽에 외래 키가 존재하기 때문이다. 따라서 @ManyToOne, @OneToMany 중 mappedBy를 쓸 수 있는 곳은 @OneToMany 뿐이다.  
- 따라서 일대다(일이 연관관계의 주인) 관계로 설정하는 것은 다대일로 설정하는 것에 비해 단점이 많고, 일대다로 할 수 있는 것들은 당연히도 다대일로 전부 표현이 가능하기 때문에 다대일로 하는 것이 좋다.  

### 결론 및 정리   
---  
- 일대다 단방향은 일대다에서 일이 연관관계의 주인  
- 테이블 일대다 관계는 항상 다 쪽에 외래 키가 있음  
- 객체와 테이블의 차이 때문에 반대편 테이블의 외래 키를 관리하는 특이한 구조  
- JoinColumn을 꼭 사용해야 함. 그렇지 않으면 조인 테이블 방식을 사용함(중간에 테이블(team_member)을 하나 추가함) → 성능상 애매하고 운영이 어려움  
>**엔티티 매핑에서 가장 베스트 방법은 다대일 단방향 관계를 하고 필요하면 양방향을 추가하는 것이다.**  
